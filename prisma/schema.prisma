generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
  FINANCE
}

enum RequestStatus {
  DRAFT
  SUBMITTED
  SEMI_APPROVED
  APPROVED
  REJECTED
  PAID
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum ApprovalDecision {
  APPROVED
  REJECTED
}

enum NotificationType {
  INFO
  WARNING
  ERROR
}

enum PaymentMethodType {
  BANK
  PAYPAL
  MOBILE_MONEY
}

model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  password String
  role     UserRole @default(EMPLOYEE)

  departmentId String @map("department_id")

  isActive Boolean @default(true) @map("is_active")

  otpHash      String?
  otpExpiresAt DateTime?
  otpVerified  Boolean   @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  department         Department          @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  managedDepartments DepartmentManager[]
  requests           Request[]
  approvals          Approval[]
  payments           Payment[]
  notifications      Notification[]
  paymentMethods     PaymentMethod[]

  @@map("users")
}

model Department {
  id          String  @id @default(uuid())
  name        String  @unique @db.VarChar(100)
  code        String? @unique @db.VarChar(50)
  description String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  users    User[]
  managers DepartmentManager[]
  requests Request[]

  @@map("departments")
}

model DepartmentManager {
  id           String @id @default(uuid())
  userId       String
  departmentId String

  assignedAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([departmentId])
  @@map("department_managers")
}

model Request {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  departmentId  String        @map("department_id")
  title         String        @db.VarChar(255)
  resourceName  String        @map("resource_name") @db.VarChar(255)
  resourceType  String        @map("resource_type") @db.VarChar(100)
  description   String?       @db.Text
  quantity      Int
  estimatedCost Decimal       @map("estimated_cost") @db.Decimal(10, 2)
  priority      Priority      @default(MEDIUM)
  status        RequestStatus @default(DRAFT)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  approvals  Approval[]
  payment    Payment?

  @@index([userId])
  @@index([departmentId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@index([departmentId, status])
  @@index([status, createdAt])
  @@map("requests")
}

model Approval {
  id           String           @id @default(uuid())
  requestId    String           @map("request_id")
  approverId   String           @map("approver_id")
  decision     ApprovalDecision
  comment      String?          @db.Text
  decisionDate DateTime         @default(now()) @map("decision_date")

  request  Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approver User    @relation(fields: [approverId], references: [id], onDelete: Restrict)

  @@index([requestId])
  @@index([approverId])
  @@index([decision])
  @@map("approvals")
}

model Payment {
  id               String   @id @default(uuid())
  requestId        String   @unique @map("request_id")
  financeOfficerId String   @map("finance_officer_id")
  amountPaid       Decimal  @map("amount_paid") @db.Decimal(10, 2)
  paymentMethod    String   @map("payment_method") @db.VarChar(50)
  paymentDate      DateTime @default(now()) @map("payment_date")

  request        Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  financeOfficer User    @relation(fields: [financeOfficerId], references: [id], onDelete: Restrict)

  @@index([financeOfficerId])
  @@index([paymentDate])
  @@index([paymentMethod])
  @@map("payments")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String           @db.VarChar(255)
  message   String           @db.Text
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PaymentMethod {
  id     String            @id @default(uuid())
  userId String            @map("user_id")
  type   PaymentMethodType

  bankName      String? @map("bank_name") @db.VarChar(100)
  accountNumber String? @map("account_number") @db.VarChar(50)
  accountName   String? @map("account_name") @db.VarChar(100)

  paypalEmail String? @map("paypal_email") @db.VarChar(255)

  // Mobile Money details
  phoneNumber String? @map("phone_number") @db.VarChar(20)
  provider    String? @db.VarChar(50)

  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("payment_methods")
}
